# PHP_2022

https://otus.ru/lessons/razrabotchik-php/?utm_source=github&utm_medium=free&utm_campaign=otus

## Описание/Пошаговая инструкция выполнения домашнего задания:

1. Необходимо реализовать Rest API с использованием очередей.
2. Ваши клиенты будут отправлять запросы на обработку, а вы будете складывать их в очередь и возвращать номер запроса.
3. В фоновом режиме вы будете обрабатывать запросы, а ваши клиенты периодически, используя номер запроса, будут проверять статус его обработки.

____________

## API энтрипоинты:

- `POST /v1/report/` - отправка данных в очередь. Придет в ответе идентификатоор задачи
- `GET  /v1/report/{id}` - получение данных отчета
- `GET  /v1/report/{id}/status` - получение состояния обработки отчета

____________

## Статусы очереди и расшифровка

- `ready` - готов к обработке в очереди 
- `in_queue` - обрабатывается в очереди
- `success` - задача обработана успешно, можно забирать результат работы
- `error` - задача обработана с ошибкой, вывод ошибки

____________

## Инструкция и объяснения

1. Скопировать `.env.exampl`e в `.env`
2. Настроить почтовик под себя - указать логин, пароль и обязательно **MAIL_FROM_ADDRESS**
3. `make console` - внутри контейнера workspace запустить слушатель кролика `php artisan rabbit`
4. залить в Postman коллекцию из папки docs/HW29.postman_collection.json

Запрос POST `http://application.local/v1/report/`

отправляем тело запроса 

```json
{
    "param1": "lol",
    "param2": "kek",
    "param3": "cheburek"
}
```

на выходе ответ будет примерно такой:

```json
{
    "status": "ready",
    "reportId": 41,
    "params": {
        "param1": "lol",
        "param2": "kek",
        "param3": "cheburek"
    }
}
```

`"status": "ready",` в теле ответа - говорит о том. что текущая задача с отчетом готова к обработке фоновым процессов в очереди. 

а в контейнере workspace при запущенном фоновом скрипте

`cli:report-queue` - произойжет подключение к кролику и отчет обработается. в разные моменты в БД будет изменяться статус задачи.

используя энтрипоинт GET `http://application.local/v1/report/41/status` - можно узнать статус задачи.

```json
{
    "reportId": 41,
    "status": "success",
    "created_at": "2022-06-12 19:49:46"
}
```

Возможные статусы описаны выше в отдельном разделе. 

По окончанию задачи на почту, которая была указана в .env в параметре **MAIL_FROM_ADDRESS** придет сообщение о готовом отчете

```
Ваш отчет был сформирован!

Номер отчета: 41
```