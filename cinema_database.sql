-- зал
drop table if exists hall cascade;
CREATE TABLE hall (
    hall_id INT GENERATED BY DEFAULT AS IDENTITY,
    hall_name VARCHAR NOT null,
	PRIMARY KEY(hall_id)
);

-- кинофильм
drop table if exists movie cascade;
CREATE TABLE movie (
    movie_id INT GENERATED BY DEFAULT AS IDENTITY,
	movie_name VARCHAR NOT null,
	PRIMARY KEY(movie_id)
);

-- тип места
drop table if exists place_type cascade;
CREATE TABLE place_type (
    place_type_id INT GENERATED BY DEFAULT AS IDENTITY,
	place_type_name VARCHAR NOT null,
	PRIMARY KEY(place_type_id)
);

-- место
drop table if exists place cascade;
CREATE TABLE place (
	place_id INT GENERATED BY DEFAULT AS IDENTITY,
	hall_id INT,
    place_type_id INT,
	row INT,
	place INT,
	PRIMARY KEY(place_id),
	CONSTRAINT fk_hall
    	FOREIGN KEY(hall_id) 
    		REFERENCES hall(hall_id),
    CONSTRAINT fk_place_type
    	FOREIGN KEY(place_type_id) 
    		REFERENCES place_type(place_type_id)
);

-- сеанс
drop table if exists session cascade;
CREATE TABLE session (
	session_id INT GENERATED BY DEFAULT AS IDENTITY,
	movie_id INT,
	hall_id INT,
	time_start TIMESTAMP, 
	time_end TIMESTAMP,
	PRIMARY KEY(session_id),
    CONSTRAINT fk_movie
    	FOREIGN KEY(movie_id) 
    		REFERENCES movie(movie_id),
    CONSTRAINT fk_hall
    	FOREIGN KEY(hall_id) 
    		REFERENCES hall(hall_id)
);

-- цена на сеанс в зависимости от типа места
drop table if exists price cascade;
CREATE TABLE price (
	price_id INT GENERATED BY DEFAULT AS IDENTITY,
	session_id INT,
	place_type_id INT,
	price INT,
	PRIMARY KEY(price_id),
    CONSTRAINT fk_session
    	FOREIGN KEY(session_id) 
    		REFERENCES session(session_id),
    CONSTRAINT fk_place_type
    	FOREIGN KEY(place_type_id) 
    		REFERENCES place_type(place_type_id)
);

-- купленные билеты
drop table if exists ticket cascade;
CREATE TABLE ticket (
	ticket_id INT GENERATED BY DEFAULT AS IDENTITY,
	place_id INT,
	session_id INT,
	PRIMARY KEY(ticket_id),
    CONSTRAINT fk_place
    	FOREIGN KEY(place_id) 
    		REFERENCES place(place_id),
    CONSTRAINT fk_session
    	FOREIGN KEY(session_id) 
    		REFERENCES session(session_id)
);


-- зал
insert into hall (hall_id, hall_name) values (1, 'Большой зал');
insert into hall (hall_id, hall_name) values (2, 'Малый зал');
insert into hall (hall_id, hall_name) values (3, 'VIP зал');

-- кинофильмы
insert into movie (movie_id, movie_name) values (1, 'Форрест Гамп');
insert into movie (movie_id, movie_name) values (2, 'Облачный атлас');

-- типы мест
insert into place_type (place_type_id, place_type_name) values (1, 'Табуретка');
insert into place_type (place_type_id, place_type_name) values (2, 'VIP диванчик');

-- места
insert into place (place_id, hall_id, place_type_id, row, place) values (1111, 1, 1, 1, 1);
insert into place (place_id, hall_id, place_type_id, row, place) values (1112, 1, 1, 1, 2);
insert into place (place_id, hall_id, place_type_id, row, place) values (1113, 1, 1, 1, 3);

insert into place (place_id, hall_id, place_type_id, row, place) values (2111, 2, 1, 1, 1);
insert into place (place_id, hall_id, place_type_id, row, place) values (2112, 2, 1, 1, 2);

insert into place (place_id, hall_id, place_type_id, row, place) values (3211, 3, 2, 1, 1);
insert into place (place_id, hall_id, place_type_id, row, place) values (3212, 3, 2, 1, 2);

-- сеансы
insert into session (session_id, movie_id, hall_id, time_start, time_end) values (1, 1, 1, '2022-07-01 10:00:00', '2022-07-01 12:00:00');
insert into session (session_id, movie_id, hall_id, time_start, time_end) values (2, 1, 1, '2022-07-01 13:00:00', '2022-07-01 15:00:00');
insert into session (session_id, movie_id, hall_id, time_start, time_end) values (3, 2, 2, '2022-07-01 10:00:00', '2022-07-01 12:00:00');
insert into session (session_id, movie_id, hall_id, time_start, time_end) values (4, 2, 2, '2022-07-01 13:00:00', '2022-07-01 15:00:00');
insert into session (session_id, movie_id, hall_id, time_start, time_end) values (5, 2, 3, '2022-07-01 21:00:00', '2022-07-01 23:00:00');

-- цены
insert into price (session_id, place_type_id, price) values (1, 1, 100);
insert into price (session_id, place_type_id, price) values (2, 1, 100);
insert into price (session_id, place_type_id, price) values (3, 1, 200);
insert into price (session_id, place_type_id, price) values (4, 1, 200);
insert into price (session_id, place_type_id, price) values (5, 2, 300);

-- билеты на сеанс 
insert into ticket (session_id, place_id) values (1, 1111);
insert into ticket (session_id, place_id) values (1, 1112);
insert into ticket (session_id, place_id) values (1, 1113);

insert into ticket (session_id, place_id) values (2, 1111);
insert into ticket (session_id, place_id) values (2, 1112);
insert into ticket (session_id, place_id) values (2, 1113);

insert into ticket (session_id, place_id) values (3, 2111);
insert into ticket (session_id, place_id) values (3, 2112);

insert into ticket (session_id, place_id) values (4, 2111);
insert into ticket (session_id, place_id) values (4, 2112);

insert into ticket (session_id, place_id) values (5, 3211);
insert into ticket (session_id, place_id) values (5, 3212);


-- вычисляем самый прибыльный фильм
select SUM(price.price) as sum, movie.movie_name from  ticket
join place on ticket.place_id = place.place_id
join place_type on place.place_type_id = place_type.place_type_id
join session on ticket.session_id = session.session_id
join movie on session.movie_id = movie.movie_id
join price on ticket.session_id = price.session_id and place.place_type_id = price.place_type_id
group by movie.movie_id
order by sum desc limit 1;
